<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secure checkout</title>
  <style>
    :root {
      --bg0: #0b0f17;
      --bg1: #0f172a;
      --card: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.12);
      --text: rgba(255, 255, 255, 0.92);
      --muted: rgba(255, 255, 255, 0.68);
      --accent: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --btn: rgba(255,255,255,0.08);
      --btnHover: rgba(255,255,255,0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(99,102,241,0.20), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(59,130,246,0.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 28px;
    }
    .card {
      width: min(980px, 100%);
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 18px;
      padding: 28px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 14px;
    }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(255,255,255,0.03), 0 0 24px rgba(34,197,94,0.25);
    }
    h1 {
      margin: 0 0 10px 0;
      font-size: clamp(22px, 3vw, 34px);
      letter-spacing: -0.02em;
    }
    p { margin: 0; color: var(--muted); line-height: 1.55; font-size: 15px; }
    .grid { margin-top: 18px; display: grid; gap: 14px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.1fr 0.9fr; } }
    .box {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius: 14px;
      padding: 14px;
    }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--muted);
      font-size: 13px;
    }
    code {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 2px 6px;
      border-radius: 8px;
      color: rgba(255,255,255,0.88);
      word-break: break-all;
    }
    .tabs { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .tab {
      border: 1px solid var(--border);
      background: var(--btn);
      color: rgba(255,255,255,0.85);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
    }
    .tab:hover { background: var(--btnHover); }
    .tab.active { border-color: rgba(34,197,94,0.55); box-shadow: 0 0 0 4px rgba(34,197,94,0.10); }
    .btn {
      width: 100%;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(34,197,94,0.18);
      color: rgba(255,255,255,0.92);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
    }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .status { margin-top: 10px; font-size: 13px; color: var(--muted); }
    .status.err { color: rgba(239,68,68,0.95); }
    .status.warn { color: rgba(245,158,11,0.95); }
    .footer { margin-top: 16px; color: rgba(255,255,255,0.55); font-size: 12px; }
    #card-container, #cashapp-container { margin-top: 12px; }
  </style>
</head>
<body>
  <main class="card" role="main">
    <div class="badge"><span class="dot"></span> Secure checkout (Square)</div>
    <h1>Pay securely</h1>
    <p>This page tokenizes payment details in your browser. Card details never touch the bot server.</p>

    <div class="grid">
      <section class="box">
        <div class="row">
          <div class="pill"><strong>Amount</strong>: <span id="amount">—</span></div>
          <div class="pill"><strong>Reference</strong>: <code id="ref">—</code></div>
        </div>

        <div class="tabs" style="margin-top:14px;">
          <div id="tab-card" class="tab active">Credit/Debit Card</div>
          <div id="tab-cashapp" class="tab">Cash App Pay</div>
          <div id="tab-applepay" class="tab">Apple Pay</div>
        </div>

        <div id="card-container"></div>
        <div id="cashapp-container" style="display:none;"></div>
        <div id="applepay-container" style="display:none;"></div>

        <button id="payBtn" class="btn" disabled>Loading…</button>
        <div id="status" class="status"></div>
      </section>

      <aside class="box">
        <p><strong>After payment</strong>: return to your Discord purchase ticket. The bot will confirm and post your activation key there.</p>
        <p style="margin-top:10px;">If you paid but don’t see an update after a minute or two, just wait—some payment methods can take a moment to finalize.</p>
        <div class="footer">You can close this tab after the payment says “completed”.</div>
      </aside>
    </div>
  </main>

  <script>
    (function () {
      const statusEl = document.getElementById("status");
      const payBtn = document.getElementById("payBtn");
      const amountEl = document.getElementById("amount");
      const refEl = document.getElementById("ref");

      const tabCard = document.getElementById("tab-card");
      const tabCash = document.getElementById("tab-cashapp");
      const tabApple = document.getElementById("tab-applepay");
      const cardContainer = document.getElementById("card-container");
      const cashContainer = document.getElementById("cashapp-container");
      const appleContainer = document.getElementById("applepay-container");

      const qp = new URLSearchParams(window.location.search || "");
      const ref = (qp.get("ref") || "").trim();
      const api = (qp.get("api") || "").trim();

      refEl.textContent = ref || "—";

      function setStatus(msg, kind) {
        statusEl.textContent = msg || "";
        statusEl.className = "status" + (kind ? (" " + kind) : "");
      }

      function assertConfig() {
        if (!ref) throw new Error("Missing ref");
        if (!api) throw new Error("Missing api (bot endpoint base URL)");
      }

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = true;
          s.onload = () => resolve();
          s.onerror = () => reject(new Error("Failed to load " + src));
          document.head.appendChild(s);
        });
      }

      let payments = null;
      let paymentRequest = null;
      let card = null;
      let cashAppPay = null;
      let applePay = null;
      let selected = "card";
      let cfg = null;

      function setSelected(which) {
        selected = which;
        tabCard.classList.toggle("active", which === "card");
        tabCash.classList.toggle("active", which === "cashapp");
        tabApple.classList.toggle("active", which === "applepay");
        cardContainer.style.display = (which === "card") ? "" : "none";
        cashContainer.style.display = (which === "cashapp") ? "" : "none";
        appleContainer.style.display = (which === "applepay") ? "" : "none";
        setStatus("");
      }

      tabCard.addEventListener("click", () => setSelected("card"));
      tabCash.addEventListener("click", () => setSelected("cashapp"));
      tabApple.addEventListener("click", () => setSelected("applepay"));

      async function fetchConfig() {
        const url = api.replace(/\/+$/,"") + "/square/config?ref=" + encodeURIComponent(ref);
        const res = await fetch(url, { method: "GET" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data || !data.ok) {
          throw new Error((data && data.error) ? data.error : ("Config failed (HTTP " + res.status + ")"));
        }
        return data;
      }

      async function postPayment(sourceId, attemptId) {
        const url = api.replace(/\/+$/,"") + "/square/create-payment";
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ref, sourceId, attemptId })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data || !data.ok) {
          throw new Error((data && data.error) ? data.error : ("Payment failed (HTTP " + res.status + ")"));
        }
        return data;
      }

      async function init() {
        try {
          assertConfig();
          setStatus("Fetching checkout details…");
          payBtn.disabled = true;
          payBtn.textContent = "Loading…";

          cfg = await fetchConfig();
          amountEl.textContent = cfg.amount || "—";

          const squareJs = cfg.sandbox
            ? "https://sandbox.web.squarecdn.com/v1/square.js"
            : "https://web.squarecdn.com/v1/square.js";
          await loadScript(squareJs);
          if (!window.Square) throw new Error("Square JS failed to initialize");

          payments = window.Square.payments(cfg.applicationId, cfg.locationId);

          // Payment request (used by Cash App Pay + Apple Pay).
          // Keep it minimal and US-focused since this bot charges USD.
          try {
            const cents = Number(cfg.amountCents || 0);
            const currency = String(cfg.currency || "USD").toUpperCase();
            const country = String(cfg.countryCode || "US").toUpperCase();
            const total = (cents > 0) ? (cents / 100).toFixed(2) : "0.00";
            paymentRequest = payments.paymentRequest({
              countryCode: country,
              currencyCode: currency,
              total: {
                amount: total,
                label: String(cfg.product || "Total").slice(0, 60) || "Total"
              }
            });
          } catch (e) {
            paymentRequest = null;
          }

          // Card
          try {
            card = await payments.card();
            await card.attach("#card-container");
          } catch (e) {
            throw new Error("Card form init failed: " + (e && e.message ? e.message : String(e)));
          }

          // Cash App Pay (optional)
          try {
            // Prefer the documented pattern: cashAppPay(paymentRequest, { redirectURL, referenceId })
            // but keep a fallback for older SDK variants.
            if (paymentRequest) {
              try {
                cashAppPay = await payments.cashAppPay(paymentRequest, {
                  redirectURL: window.location.href,
                  referenceId: ref
                });
              } catch (e0) {
                cashAppPay = await payments.cashAppPay({
                  redirectURL: window.location.href,
                  referenceId: ref,
                  paymentRequest
                });
              }
            } else {
              cashAppPay = await payments.cashAppPay({
                redirectURL: window.location.href,
                referenceId: ref,
              });
            }
            await cashAppPay.attach("#cashapp-container");
          } catch (e) {
            // Don't hard-fail the page if Cash App Pay can't be initialized (region/merchant settings).
            cashAppPay = null;
            tabCash.style.opacity = "0.55";
            tabCash.title = "Cash App Pay unavailable for this merchant/session";
          }

          // Apple Pay (optional)
          try {
            if (!paymentRequest) throw new Error("missing paymentRequest");
            applePay = await payments.applePay(paymentRequest);
            // Some environments support the API but cannot make payments; detect when possible.
            try {
              if (applePay && typeof applePay.canMakePayment === "function") {
                const can = await applePay.canMakePayment();
                if (!can) throw new Error("Apple Pay not available");
              }
            } catch (e1) {
              throw e1;
            }
            await applePay.attach("#applepay-container");
          } catch (e) {
            applePay = null;
            tabApple.style.opacity = "0.55";
            tabApple.title = "Apple Pay unavailable (needs verification + supported device/browser)";
          }

          payBtn.disabled = false;
          payBtn.textContent = "Pay now";
          setStatus("Ready.");
        } catch (e) {
          payBtn.disabled = true;
          payBtn.textContent = "Unavailable";
          setStatus((e && e.message) ? e.message : String(e), "err");
        }
      }

      payBtn.addEventListener("click", async () => {
        if (!payments) return;
        try {
          payBtn.disabled = true;
          setStatus("Processing payment…");
          const attemptId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "-" + String(Math.random()).slice(2);

          let result = null;
          if (selected === "cashapp") {
            if (!cashAppPay) throw new Error("Cash App Pay is not available on this checkout.");
            result = await cashAppPay.tokenize();
          } else if (selected === "applepay") {
            if (!applePay) throw new Error("Apple Pay is not available on this checkout.");
            result = await applePay.tokenize();
          } else {
            result = await card.tokenize();
          }

          if (!result || result.status !== "OK" || !result.token) {
            const err = (result && result.errors && result.errors[0] && result.errors[0].message) ? result.errors[0].message : "Tokenization failed.";
            throw new Error(err);
          }

          const resp = await postPayment(result.token, attemptId);
          if (resp.status === "PENDING") {
            setStatus("Payment submitted. Waiting for confirmation… (You can return to Discord.)", "warn");
          } else {
            setStatus("Payment completed. Return to Discord.", "");
          }
        } catch (e) {
          setStatus((e && e.message) ? e.message : String(e), "err");
        } finally {
          payBtn.disabled = false;
        }
      });

      init();
    })();
  </script>
</body>
</html>

